SAFE-UPDATE / FIX BLOCKERS (95% confidence required)  
!! Ne modifie rien sur main tant que tout nâ€™est pas vert !!

ðŸŽ¯ Objectif
Corriger les 4 blockers (TS errors, tests KO, auth/routes healthcheck, build) SANS casser les fonctionnalitÃ©s ni les configs existantes, puis produire un ZIP exportable et cohÃ©rent pour prÃ©prod/prod.

ðŸ”’ RÃ¨gles gÃ©nÃ©rales
- Travaille dans une branche dÃ©diÃ©e : `safe-fix-$(date +%Y%m%d%H%M)`.
- Pas plus de 30 lignes modifiÃ©es par fichier sans mon accord.
- AprÃ¨s chaque micro-lot : `pnpm tsc --noEmit`, `pnpm test`, quick smoke (`pnpm dev` 30s) â†’ si doute <95%, STOP & ask.
- Ne touche pas aux secrets et fichiers dâ€™infra (.env, .replit, replit.nix, package.json) sans justification.
- Ne supprime pas de code â€œjuste pour faire passer TSâ€. PrÃ©fÃ¨re : typer correctement, fallback, garde backward compatibility.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
PHASE 0 â€” Re-sync & Contexte
1. `git checkout -b safe-fix-$(date +%Y%m%d%H%M)`
2. Re-lance lâ€™audit pour contexte Ã  jour :  
pnpm tsx scripts/audit_repo.ts

markdown
Copier
Modifier
3. Affiche-moi :  
- nb dâ€™erreurs TS + liste fichiers/lines  
- nb tests failing + noms  
- status auth/routes (/api/auth/user, /api/woo/products, /api/wp/pages/privacy) via `curl` local  
Puis STOP.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
PHASE 1 â€” Corriger TypeScript (blockers)
But : 0 erreur TS.

Plan (adapter selon rÃ©sultats exacts, mais typiquement) :
A. UI/Beat types (Beat vs UIBeat) & props manquants (BeatCard, ResponsiveBeatCard, AddToCartButton).  
- Ajouter champs requis (genre, created_at, wordpress_id) via mapping avant de passer Ã  BeatCard.  
- Ã‰viter dâ€™introduire `any`; prÃ©fÃ¨re Pick/Partial + fallback.

B. LazyComponents generics  
- Importer explicitement les Props types de chaque composant lazy (WaveformAudioPlayerProps, AdvancedBeatFiltersProps, etc.)  
- `withLazyLoading<TProps extends Record<string, unknown>>` + signatures correctes et remove ts-expect-error inutilisÃ©s.

C. Payment pages (PaymentPlan type export, setState signatures)  
- Exporter lâ€™interface `PaymentPlan` depuis PaymentPlanSelector.  
- Adapter `(plan: PaymentPlan | null) => void` et SetStateAction correctement.

D. Misc: MembershipPage billingInterval "yearly" â†’ "annual"; shop.tsx filters typing; remove `is_free` non dÃ©fini dans UIBeat; WordPress PageRenderer (renderedâ†’html); etc.

ProcÃ©dure :
- Corrige par sous-lots (A, B, C, D).  
- AprÃ¨s chaque sous-lot :
pnpm tsc --noEmit > .reports/tsc_phaseX.txt 2>&1 || true

markdown
Copier
Modifier
STOP si encore >0 erreurs pour montrer diff & plan suivant.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
PHASE 2 â€” Tests Jest
1. `pnpm test --silent` â†’ lister tests KO.  
2. Pour chaque test KO : patch minimal (mocks Supabase/Stripe/Woo dÃ©jÃ  en place).  
3. Ajoute tests manquants si nÃ©cessaire (ex: routes WP/woo migrated).  
4. VÃ©rifie couverture minimale inchangÃ©e (ou note la baisse).  
STOP et montre le rapport.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
PHASE 3 â€” Smoke & Healthchecks
1. Lancer `pnpm dev` sur port choisi (utilise choosePort dÃ©jÃ  implÃ©mentÃ©).  
2. VÃ©rifier rapidement (curl/fetch) :
 - GET /api/auth/user (renvoie 401 sans session, 200 avec session)  
 - GET /api/woo/products?min_price=0  
 - GET /api/wp/pages/privacy  
 - GET /api/downloads (401 si non loguÃ©)  
3. Si un endpoint casse â†’ patch ciblÃ© (â‰¤30 lignes).  
STOP et rapport.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
PHASE 4 â€” MISSING_FEATURES.md & Rapport final
1. RÃ©-exÃ©cute `pnpm tsx scripts/audit_repo.ts` â†’ gÃ©nÃ¨re `.reports/audit.md` actualisÃ©.  
2. Mets Ã  jour `MISSING_FEATURES.md` :
 - Marque DONE ce qui lâ€™est rÃ©ellement.  
 - Ajoute ce qui manque encore (referrals backend, RLS policies, quotas downloads, etc.).  
 - Classer P0/P1/P2.  
3. CrÃ©e `POST_UPDATE_REPORT.md` :
 - RÃ©sumÃ© des changements (par fichier/groupe)  
 - Ã‰tat final (TS OK, tests OK, endpoints OK)  
 - TODO restants avant prÃ©prod/prod  
 - Instructions pour moi (git pull, zip export)

Commit :
git add .
git commit -m "chore(safe-fix): TS/tests fixed, audit updated"

bash
Copier
Modifier

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
PHASE 5 â€” Export prÃªt
1. GÃ©nÃ¨re un ZIP propre (sans node_modules si volumineux) :
./scripts/make_export_zip.sh # si non existant, crÃ©e-le : zip -r build-export.zip . -x "node_modules/" ".git/"

markdown
Copier
Modifier
2. STOP et donne-moi le chemin du ZIP + diff final + instructions merge (`git push origin safe-fix-...`).

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
IMPORTANT
- A CHAQUE doute <95% : pose-moi la question.  
- Ne merge pas dans main sans mon feu vert.

âž¡ï¸ Lance PHASE 0 maintenant, puis attends mon OK Ã  chaque STOP.