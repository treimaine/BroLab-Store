---
alwaysApply: true
---

# üéµ BROLAB ENTERTAINMENT - R√àGLES DE D√âVELOPPEMENT

## üìã √âTAT ACTUEL DE L'APPLICATION (Janvier 2025)

### üèóÔ∏è ARCHITECTURE TECHNIQUE

**Stack Principal :**

- **Frontend** : React 18.3.1 + TypeScript 5.6.3 + Vite 6.3.5 + Tailwind CSS 3.4.17
- **Backend** : Express.js 4.21.2 + TypeScript + Node.js 24.x
- **Base de donn√©es** : Convex 1.31.2 (19 tables)
- **Authentification** : Clerk 5.59.2 (remplacement Supabase Auth)
- **Paiements** : Stripe 18.4.0 + PayPal SDK 1.1.0 (int√©gration directe)
- **Routing** : Wouter 3.3.5 (remplacement React Router)
- **State Management** : TanStack Query 5.60.5 + Convex + Zustand 5.0.6
- **UI Components** : Radix UI + shadcn/ui + Framer Motion 11.18.2
- **Audio** : WaveSurfer.js 7.10.0

**Migration Compl√©t√©e :**

- ‚úÖ **Supabase ‚Üí Convex** : Base de donn√©es migr√©e (19 tables)
- ‚úÖ **Supabase Auth ‚Üí Clerk** : Authentification migr√©e (Clerk 5.59.2)
- ‚úÖ **React Router ‚Üí Wouter** : Routing migr√© (Wouter 3.3.5)
- ‚úÖ **Paiements** : Stripe + PayPal int√©gr√©s directement (pas Clerk Billing)

**Note importante** : Clerk est utilis√© uniquement pour l'authentification. Les paiements utilisent Stripe et PayPal directement via leurs SDKs respectifs.

### üéØ FONCTIONNALIT√âS PRINCIPALES

#### 1. **Store de Beats**

- Catalogue complet avec filtres avanc√©s (genre, BPM, cl√©, mood)
- Recherche en temps r√©el avec suggestions
- Affichage grille/tableau avec pagination
- Syst√®me de favoris
- Pr√©visualisation audio avec WaveSurfer.js
- Gestion des licences (Basic $29.99, Premium $49.99, Unlimited $149.99)
- Synchronisation WooCommerce pour le catalogue

#### 2. **Syst√®me d'Authentification**

- Inscription/Connexion via Clerk
- Profils utilisateurs complets
- Synchronisation automatique Clerk ‚Üî Convex (useClerkSync)
- Gestion des r√¥les (user, admin, artist)
- Protection des routes (ProtectedRoute)
- Gestion des sessions et tokens

#### 3. **Dashboard Utilisateur**

- Vue d'ensemble des statistiques (commandes, t√©l√©chargements, favoris)
- Gestion des t√©l√©chargements avec licences PDF
- Historique des commandes avec d√©tails
- Gestion des favoris
- Profil utilisateur avec pr√©f√©rences
- Param√®tres du compte
- Analytics avec graphiques (Recharts)

#### 4. **Syst√®me de Paiement**

- Int√©gration Stripe Checkout (18.4.0)
- Int√©gration PayPal SDK (1.1.0)
- Gestion des licences (Basic $29.99, Premium $49.99, Unlimited $149.99)
- Webhooks Stripe et PayPal valid√©s
- Historique des paiements et factures PDF
- Gestion des quotas de t√©l√©chargement par licence
- Support multi-devises

#### 5. **Services de Production**

- R√©servation mixing/mastering
- Sessions d'enregistrement
- Consultation production
- Commandes de beats personnalis√©s
- Gestion des r√©servations avec calendrier ICS
- Notifications email automatiques

### üîß COMPOSANTS PRINCIPAUX

#### **Composants UI (shadcn/ui)**

```typescript
// Composants disponibles (36 composants)
- Button, Input, Card, Badge, Modal
- Tabs, Accordion, Collapsible, Select
- Slider, Checkbox, Radio, Switch
- Toast, Tooltip, Dialog, Popover
- Table, Pagination, Loading states
- Progress, Separator, ScrollArea
```

#### **Composants M√©tier (Organis√©s par feature)**

```typescript
// Structure : client/src/components/[feature]/

// Store & Beats (beats/)
(-BeatCard,
  ResponsiveBeatCard,
  TableBeatView - OptimizedBeatGrid,
  UnifiedFilterPanel - AdvancedBeatFilters,
  FeaturedBeatsCarousel - RecentlyViewedBeats,
  BeatStemsDelivery -
    // Dashboard (dashboard/)
    ModernDashboard,
  EnhancedAnalytics - StatsCards,
  OrdersTab,
  DownloadsTable - ReservationsTab,
  ActivityFeed - DataExportManager,
  NotificationCenter -
    // Audio & Media (audio/)
    WaveformPlayer,
  EnhancedWaveformPlayer - GlobalAudioPlayer,
  EnhancedGlobalAudioPlayer - SonaarAudioPlayer,
  SonaarModernPlayer - HoverPlayButton,
  ProductArtworkPlayer -
    // Paiements (payments/)
    StripeCheckout,
  PayPalButton - CompletePaymentFlow,
  PaymentWebhookHandler -
    // Licences (licenses/)
    LicensePicker,
  LicensePreviewModal -
    license -
    preview -
    // Layout & Navigation (layout/)
    Navbar,
  Footer,
  MobileBottomNav - SearchHero,
  ServicesStrip,
  SocialProofStrip -
    // Auth (auth/)
    ProtectedRoute,
  AuthenticatedContent - UserProfile,
  ClerkSyncProvider - ClerkErrorBoundary,
  ClerkFallback -
    // Errors (errors/)
    ErrorBoundary,
  EnhancedErrorHandling - BroLabErrorHandler,
  ErrorContext);
```

### üì± PAGES PRINCIPALES

#### **Pages Publiques**

```typescript
- / (Home) : Page d'accueil avec hero et beats featured
- /shop : Catalogue complet des beats avec filtres
- /product/:id : D√©tail d'un beat avec preview audio
- /about : √Ä propos de BroLab
- /contact : Formulaire de contact
- /faq : Questions fr√©quentes
- /terms, /privacy, /copyright : Pages l√©gales
```

#### **Pages Authentifi√©es**

```typescript
- /dashboard : Dashboard utilisateur principal
- /membership : Gestion des abonnements (si applicable)
- /wishlist : Liste des favoris
- /cart : Panier d'achat
- /checkout : Processus de paiement Stripe/PayPal
- /order-confirmation : Confirmation de commande
```

#### **Pages de Services**

```typescript
- /mixing-mastering : R√©servation services
- /recording-sessions : Sessions d'enregistrement
- /custom-beats : Commandes personnalis√©es
- /production-consultation : Consultation production
- /premium-downloads : T√©l√©chargements premium
```

### üóÑÔ∏è SCH√âMA DE BASE DE DONN√âES (Convex)

#### **Tables Principales (19 tables)**

```typescript
// Users
users: {
  clerkId: string,           // ID Clerk
  email: string,            // Email utilisateur
  username?: string,        // Nom d'utilisateur
  firstName?: string,       // Pr√©nom
  lastName?: string,        // Nom
  imageUrl?: string,        // Avatar
  role?: string,            // 'user', 'admin', 'artist'
  isActive?: boolean,       // Compte actif
  lastLoginAt?: number,     // Derni√®re connexion
  preferences?: object,     // Pr√©f√©rences structur√©es
  metadata?: object,        // M√©tadonn√©es
  createdAt: number,        // Date cr√©ation
  updatedAt: number         // Date modification
}

// Beats/Products
beats: {
  wordpressId: number,      // ID WordPress
  title: string,            // Titre du beat
  description?: string,     // Description
  genre: string,            // Genre musical
  bpm: number,              // BPM
  key?: string,             // Cl√© musicale
  mood?: string,            // Ambiance
  price: number,            // Prix (centimes)
  audioUrl?: string,        // URL audio
  imageUrl?: string,        // URL image
  tags?: string[],          // Tags
  featured?: boolean,       // Mis en avant
  downloads?: number,       // Nombre t√©l√©chargements
  views?: number,           // Nombre vues
  duration?: number,        // Dur√©e
  isActive?: boolean,       // Actif
  createdAt: number,        // Date cr√©ation
  updatedAt?: number        // Date modification
}

// Orders
orders: {
  userId?: Id<"users">,     // ID utilisateur Convex
  clerkUserId?: string,     // ID utilisateur Clerk
  sessionId?: string,       // ID session
  items: any[],             // Items commande
  amount: number,           // Montant total (centimes)
  currency: string,         // Devise
  status: string,           // Statut commande
  paymentMethod?: string,   // 'stripe' | 'paypal'
  paymentIntentId?: string, // ID Stripe Payment Intent
  metadata?: any,           // M√©tadonn√©es
  createdAt: number,        // Date cr√©ation
  updatedAt: number         // Date modification
}

// Payments (Stripe)
payments: {
  orderId: Id<"orders">,    // ID commande
  provider: string,         // 'stripe' | 'paypal'
  status: string,           // 'succeeded' | 'failed' | 'refunded'
  amount: number,           // Montant en centimes
  currency: string,         // Devise
  stripePaymentIntentId?: string, // ID Stripe
  stripeChargeId?: string, // ID charge Stripe
  createdAt: number         // Date cr√©ation
}

// Downloads
downloads: {
  userId: Id<"users">,      // ID utilisateur
  beatId: number,           // ID beat
  licenseType: string,      // Type licence
  downloadUrl: string,      // URL t√©l√©chargement
  timestamp: number,        // Timestamp
  metadata?: any            // M√©tadonn√©es
}

// Favorites
favorites: {
  userId: Id<"users">,      // ID utilisateur
  beatId: number,           // ID beat
  createdAt: number         // Date cr√©ation
}

// Reservations
reservations: {
  userId?: Id<"users">,     // ID utilisateur
  serviceType: string,      // Type service
  status: string,           // Statut r√©servation
  details: any,             // D√©tails
  preferredDate: string,    // Date souhait√©e
  durationMinutes: number,  // Dur√©e (minutes)
  totalPrice: number,       // Prix total
  notes?: string,           // Notes
  createdAt: number,        // Date cr√©ation
  updatedAt: number         // Date modification
}

// Licenses (PDF certificates)
licenses: {
  orderId: string,          // ID commande
  itemId: string,           // ID item commande
  beatId: number,           // ID beat
  beatTitle: string,        // Titre beat
  licenseType: string,      // 'basic' | 'premium' | 'unlimited'
  licenseNumber: string,    // Num√©ro licence unique
  buyerEmail: string,       // Email acheteur
  buyerName: string,        // Nom acheteur
  buyerUserId?: string,     // ID utilisateur Clerk
  price: number,            // Prix pay√© (centimes)
  currency: string,         // Devise
  pdfStorageId: string,     // ID stockage Convex
  pdfUrl: string,           // URL publique PDF
  purchaseDate: number,     // Date achat
  createdAt: number,        // Date cr√©ation
  updatedAt: number         // Date modification
}

// Subscriptions (si syst√®me d'abonnement utilis√©)
subscriptions: {
  userId: Id<"users">,      // ID utilisateur
  plan: string,             // Plan (si applicable)
  status: string,           // Statut
  features: string[],       // Fonctionnalit√©s
  downloadQuota: number,    // Quota t√©l√©chargements
  downloadUsed: number,     // T√©l√©chargements utilis√©s
  createdAt: number,        // Date cr√©ation
  updatedAt: number         // Date modification
}
```

### üîê SYST√àME D'AUTHENTIFICATION (Clerk)

#### **Configuration**

```typescript
// main.tsx
<ClerkProvider publishableKey={clerkPublishableKey}>
  <ConvexProviderWithClerk client={convex} useAuth={useAuth}>
    <App />
  </ConvexProviderWithClerk>
</ClerkProvider>
```

#### **Hooks d'Authentification**

```typescript
// Hooks disponibles
- useUser() : Informations utilisateur Clerk
- useAuth() : √âtat authentification
- useClerkSync() : Synchronisation Clerk ‚Üî Convex
- useConvexAuth() : Authentification Convex
```

#### **Synchronisation Automatique**

```typescript
// useClerkSync.ts
- Synchronisation automatique des utilisateurs
- Gestion des √©tats de chargement
- Protection contre les synchronisations multiples (globalSyncInProgress)
- Gestion des erreurs et retry avec backoff
- Utilisation de startTransition pour √©viter les suspensions
```

### üí≥ SYST√àME DE PAIEMENT (Stripe + PayPal)

#### **Licences de Beats (One-time purchases)**

```typescript
// Licences disponibles
basic: {
  price: 2999,              // $29.99 (one-time)
  features: ["mp3_format", "non-exclusive", "standard_license"]
}

premium: {
  price: 4999,             // $49.99 (one-time)
  features: ["wav_format", "commercial_use", "premium_license"]
}

unlimited: {
  price: 14999,            // $149.99 (one-time)
  features: ["all_formats", "exclusive_rights", "unlimited_license"]
}
```

#### **Composants de Paiement**

```typescript
// Composants disponibles
- StripeCheckout : Int√©gration Stripe Checkout
- PayPalButton : Int√©gration PayPal SDK
- CompletePaymentFlow : Flux complet de paiement
- PaymentWebhookHandler : Gestion webhooks Stripe/PayPal
- LicensePicker : S√©lecteur de licence
- LicensePreviewModal : Aper√ßu licence avant achat
```

#### **Webhooks**

```typescript
// Webhooks g√©r√©s
- Stripe : payment_intent.succeeded, payment_intent.failed
- PayPal : PAYMENT.SALE.COMPLETED, PAYMENT.SALE.DENIED
- Validation avec idempotence (table processedEvents)
```

### üé® SYST√àME DE DESIGN

#### **Variables CSS (design-tokens.css)**

```css
:root {
  /* Couleurs principales */
  --deep-black: hsl(240, 10%, 3.9%);
  --accent-purple: #a259ff;
  --accent-cyan: #00d4ff;
  --color-gold: #ffd700;

  /* Couleurs secondaires */
  --dark-gray: hsl(240, 10%, 3.9%);
  --medium-gray: hsl(240, 10%, 3.9%);
  --light-gray: hsl(240, 10%, 3.9%);

  /* Couleurs UI */
  --success: #10b981;
  --warning: #f59e0b;
  --error: #ef4444;
  --info: #3b82f6;
}
```

#### **Classes Tailwind Personnalis√©es**

```css
/* Classes utilitaires */
.card-dark {
  @apply bg-gray-900 border border-gray-700 rounded-lg;
}
.form-input {
  @apply bg-gray-800 border border-gray-600 text-white;
}
.btn-primary {
  @apply bg-[var(--accent-purple)] hover:bg-purple-700;
}
```

### üì± RESPONSIVE DESIGN

#### **Breakpoints**

```typescript
// Breakpoints Tailwind
sm: 640px   // Mobile landscape
md: 768px   // Tablet portrait
lg: 1024px  // Tablet landscape
xl: 1280px  // Desktop
2xl: 1536px // Large desktop
```

#### **Composants Responsive**

```typescript
// Composants adaptatifs
- MobileBottomNav : Navigation mobile
- ResponsiveBeatCard : Carte beat responsive
- OptimizedBeatGrid : Grille optimis√©e mobile
- UnifiedFilterPanel : Filtres adaptatifs
```

### üöÄ OPTIMISATIONS DE PERFORMANCE

#### **Lazy Loading**

```typescript
// Composants charg√©s √† la demande
- LazyDashboard : Dashboard avec Suspense
- LazyComponents : Composants lourds
- LoadingFallback : √âtats de chargement
- DashboardSkeleton : Squelettes de chargement
```

#### **Optimisations Images**

```typescript
// Utilitaires d'optimisation
- optimizeImage() : Optimisation des images
- OptimizedImage : Composant image optimis√©
- preloadCriticalResources() : Pr√©chargement ressources
```

#### **Monitoring Performance**

```typescript
// Outils de monitoring
- PerformanceMonitor : Mesures de performance
- ErrorTracker : Suivi des erreurs
- HealthMonitor : V√©rification des services
```

### üß™ TESTS ET VALIDATION

#### **Suite de Tests**

```typescript
// Tests disponibles (50+ fichiers de tests)
- Tests unitaires : Jest + React Testing Library
- Tests d'int√©gration : Convex Testing Helper
- Tests de performance : Bundle size, load time
- Tests de s√©curit√© : Authentification, autorisations
- Tests API : Supertest pour routes Express
```

#### **Scripts de Test**

```bash
npm run test              # Tests unitaires
npm run type-check        # V√©rification TypeScript
npm run lint              # Linting ESLint
npm run pre-check         # V√©rifications pr√©-build
```

### üîß SCRIPTS ET UTILITAIRES

#### **Scripts de D√©veloppement**

```bash
npm run dev               # Serveur de d√©veloppement
npm run client            # Client Vite
npm run build             # Build production
npm run start             # Serveur production
npm run clean             # Nettoyage complet
```

#### **Scripts de Migration**

```bash
npm run clean:all         # Nettoyage complet
npm run clean:logs        # Nettoyage logs
npm run clean:db          # Nettoyage base de donn√©es
```

### üìö DOCUMENTATION

#### **Fichiers de Documentation**

```markdown
- README.md : Documentation principale
- README-local.md : Guide d√©veloppement local
- README-deployment.md : Guide d√©ploiement
- README-responsive.md : Guide responsive design
- LOCAL_DEVELOPMENT_GUIDE.md : Guide d√©veloppement d√©taill√©
- TESTING_GUIDE.md : Guide des tests
- UNIFIED_FILTERING_SYSTEM.md : Syst√®me de filtrage
```

### üö® PROBL√àMES CONNUS

#### **Erreurs TypeScript**

```typescript
// Erreur connue dans useClerkSync.ts
client/src/hooks/useClerkSync.ts:19:40 - error TS2589:
Type instantiation is excessively deep and possibly infinite.

// Solution : Utiliser @ts-expect-error avec commentaire explicatif
// @ts-expect-error - Convex type instantiation depth issue with complex mutations
const syncUserMutation = useMutation(api.users.clerkSync.syncClerkUser);
```

#### **Limitations Actuelles**

- Extension Tailwind CSS manquante dans VS Code (erreur "Unknown at rule @tailwind")
- Certains composants legacy encore pr√©sents
- Tests de paiement en mode d√©veloppement uniquement
- 18 tests √©chou√©s sur 145 (principalement API 500 et probl√®mes Jest)

### üéØ PROCHAINES √âTAPES

#### **Phase 4 - Nettoyage & Optimisation**

- [ ] Suppression des composants obsol√®tes
- [ ] Optimisation du bundle size
- [ ] Am√©lioration des performances
- [ ] Tests de paiement complets
- [ ] Documentation finale
- [ ] Correction des tests √©chou√©s

#### **Phase 5 - D√©ploiement Production**

- [ ] Configuration o2switch
- [ ] Tests de charge
- [ ] Monitoring production
- [ ] Backup et s√©curit√©
- [ ] Formation √©quipe

### üìã R√àGLES DE D√âVELOPPEMENT

#### **Conventions de Code**

```typescript
// Naming conventions
- Composants : PascalCase (BeatCard, UserProfile)
- Hooks : camelCase avec use (useClerkSync, useUnifiedFilters)
- Fichiers : kebab-case (beat-card.tsx, user-profile.tsx)
- Types : PascalCase (BeatProduct, UnifiedFilters)
- Variables : camelCase (isLoading, hasActiveFilters)
```

#### **Structure des Composants**

```typescript
// Ordre des imports
1. React et hooks
2. Composants UI (shadcn/ui)
3. Composants m√©tier
4. Hooks personnalis√©s
5. Utilitaires et types
6. Styles et assets

// Structure du composant
1. Interface Props
2. Hooks et √©tat
3. Fonctions de gestion
4. Rendu conditionnel
5. Rendu principal
6. Export
```

#### **Gestion des Erreurs**

```typescript
// Pattern d'erreur
try {
  // Logique m√©tier
} catch (error) {
  console.error("‚ùå Error description:", error);
  // Gestion d'erreur utilisateur
}

// Composants d'erreur
- ErrorBoundary : Capture erreurs React
- EnhancedErrorHandling : Gestion avanc√©e
- LoadingFallback : √âtats de chargement
```

### üîç D√âBOGAGE ET MONITORING

#### **Logs de D√©veloppement**

```typescript
// Console logs avec emojis
console.log("üöÄ Starting application...");
console.log("‚úÖ User synced successfully");
console.log("‚ùå Error syncing user:", error);
console.log("üéµ Playing audio:", audioUrl);
console.log("üñºÔ∏è Image loaded:", imageUrl);
```

#### **Monitoring en Production**

```typescript
// M√©triques de performance
- First Contentful Paint (FCP)
- Largest Contentful Paint (LCP)
- Time to Interactive (TTI)
- Cumulative Layout Shift (CLS)
- Bundle size et chunks
```

---

**üìÖ Derni√®re mise √† jour :** 26 janvier 2025  
**üîÑ Version :** 2.1 - Architecture Convex + Clerk + Stripe/PayPal  
**üë®‚Äçüíª Statut :** Phase 4 - Nettoyage & Optimisation  
**üéØ Prochaine √©tape :** D√©ploiement production o2switch

**Note importante** : Le syst√®me utilise Stripe et PayPal directement pour les paiements, pas Clerk Billing. Clerk est utilis√© uniquement pour l'authentification et la gestion des utilisateurs.
