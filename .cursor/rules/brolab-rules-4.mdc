---
alwaysApply: true
---

# ðŸ“‹ SYSTÃˆME DE PAIEMENT - STRIPE + PAYPAL

## Documentation ComplÃ¨te - BroLab Entertainment

**Date :** 26 janvier 2025  
**Statut :** âœ… IMPLÃ‰MENTÃ‰  
**Note :** Le systÃ¨me utilise Stripe et PayPal directement, pas Clerk Billing. Clerk est utilisÃ© uniquement pour l'authentification.

---

## ðŸ“Š Ã‰TAT DES PHASES PRÃ‰CÃ‰DENTES

### âœ… PHASE 1 - CONFIGURATION & TYPES

**Statut :** TERMINÃ‰E AVEC SUCCÃˆS (100%)

- âœ… **Migration Supabase â†’ Convex** : ComplÃ¨te
- âœ… **SchÃ©mas de base de donnÃ©es** : Tous dÃ©finis et validÃ©s
- âœ… **Types TypeScript** : HarmonisÃ©s frontend/backend
- âœ… **Configuration Clerk** : Authentification fonctionnelle
- âœ… **Architecture technique** : DocumentÃ©e et validÃ©e

### âœ… PHASE 2 - RECONSTRUCTION DASHBOARD

**Statut :** TERMINÃ‰E AVEC SUCCÃˆS (95%)

- âœ… **Interface utilisateur** : Refonte complÃ¨te
- âœ… **IntÃ©gration Clerk Auth** : Synchronisation automatique
- âœ… **Composants UI** : SystÃ¨me de design BroLab
- âœ… **Performance** : OptimisÃ©e (<1s temps de rÃ©ponse)
- âœ… **Tests d'intÃ©gration** : 100% de rÃ©ussite
- âœ… **Responsive design** : Mobile-friendly

---

## ðŸŽ¯ SYSTÃˆME DE PAIEMENT ACTUEL

### Mission Principale

**SystÃ¨me de paiement complet et sÃ©curisÃ© avec Stripe et PayPal**

### FonctionnalitÃ©s ImplÃ©mentÃ©es

1. **IntÃ©gration Stripe Checkout** : Paiements par carte bancaire
2. **IntÃ©gration PayPal SDK** : Paiements PayPal
3. **Gestion des licences** : Basic ($29.99), Premium ($49.99), Unlimited ($149.99)
4. **Webhooks validÃ©s** : Synchronisation automatique Stripe/PayPal
5. **Licences PDF** : GÃ©nÃ©ration automatique de certificats de licence

---

## ðŸ—ï¸ ARCHITECTURE ACTUELLE

### Composants de Paiement Existants

#### 1. Page Checkout

```typescript
// client/src/pages/checkout.tsx
- StripeCheckout : IntÃ©gration Stripe Checkout
- PayPalButton : IntÃ©gration PayPal SDK
- LicensePicker : SÃ©lection de licence
- Interface responsive
- Gestion des erreurs de paiement
```

#### 2. Composants de Paiement

```typescript
// Composants disponibles (client/src/components/payments/) :
- StripeCheckout : IntÃ©gration Stripe Checkout
- PayPalButton : IntÃ©gration PayPal SDK
- CompletePaymentFlow : Flux complet de paiement
- PaymentWebhookHandler : Gestion webhooks
```

#### 3. Dashboard de Paiement

```typescript
// client/src/pages/dashboard
- Historique des commandes (OrdersTab)
- Historique des paiements
- Gestion des licences tÃ©lÃ©chargÃ©es
- Factures PDF
```

### Hooks et Services

#### Hooks de Paiement

```typescript
// Hooks disponibles
- useStripeCheckout : Gestion Stripe Checkout
- usePayPalPayment : Gestion PayPal
- usePaymentHistory : Historique des paiements
- useLicenseManagement : Gestion des licences
```

---

## ðŸ“‹ LICENCES DE BEATS (One-time purchases)

### License Basic - $29.99

```json
{
  "name": "Basic License",
  "price": 2999,
  "type": "one-time",
  "features": ["mp3_format", "non-exclusive", "standard_license"]
}
```

**FonctionnalitÃ©s :**

- ðŸŽµ Format MP3
- ðŸ“„ License non-exclusive
- ðŸŽ§ Usage standard
- ðŸ“§ Support par email

### License Premium - $49.99

```json
{
  "name": "Premium License",
  "price": 4999,
  "type": "one-time",
  "features": ["wav_format", "commercial_use", "premium_license"]
}
```

**FonctionnalitÃ©s :**

- ðŸŽµ Format WAV haute qualitÃ©
- ðŸ’¼ Usage commercial autorisÃ©
- ðŸŽ›ï¸ Trackouts disponibles
- ðŸš€ Support prioritaire

### License Unlimited - $149.99

```json
{
  "name": "Unlimited License",
  "price": 14999,
  "type": "one-time",
  "features": ["all_formats", "exclusive_rights", "unlimited_license"]
}
```

**FonctionnalitÃ©s :**

- ðŸ† Tous formats (MP3, WAV, STEMS)
- â­ Droits exclusifs
- ðŸŽ¯ Usage illimitÃ©
- ðŸ“ž Support direct

---

## ðŸ”§ CONFIGURATION TECHNIQUE

### Variables d'Environnement

```env
# Clerk Configuration (Authentification uniquement)
VITE_CLERK_PUBLISHABLE_KEY=pk_test_...
CLERK_SECRET_KEY=sk_test_...
CLERK_WEBHOOK_SECRET=whsec_...

# Stripe Configuration (Paiements)
STRIPE_SECRET_KEY=sk_test_...
STRIPE_PUBLISHABLE_KEY=pk_test_...
STRIPE_WEBHOOK_SECRET=whsec_...

# PayPal Configuration (Paiements)
PAYPAL_CLIENT_ID=...
PAYPAL_CLIENT_SECRET=...
PAYPAL_WEBHOOK_ID=...
PAYPAL_MODE=sandbox  # ou 'production'

# Convex
VITE_CONVEX_URL=https://...
```

### SchÃ©ma Convex - Tables Paiements

```typescript
// convex/schema.ts

// Payments (Stripe/PayPal)
payments: defineTable({
  orderId: v.id("orders"),
  provider: v.string(), // 'stripe' | 'paypal'
  status: v.string(), // 'succeeded' | 'failed' | 'refunded'
  amount: v.number(),
  currency: v.string(),
  stripePaymentIntentId: v.optional(v.string()),
  stripeChargeId: v.optional(v.string()),
  createdAt: v.number(),
})
  .index("by_order", ["orderId"])
  .index("by_pi", ["stripePaymentIntentId"]);

// Licenses (PDF certificates)
licenses: defineTable({
  orderId: v.string(),
  itemId: v.string(),
  beatId: v.number(),
  beatTitle: v.string(),
  licenseType: v.string(), // 'basic' | 'premium' | 'unlimited'
  licenseNumber: v.string(),
  buyerEmail: v.string(),
  buyerName: v.string(),
  buyerUserId: v.optional(v.string()),
  price: v.number(),
  currency: v.string(),
  pdfStorageId: v.string(),
  pdfUrl: v.string(),
  purchaseDate: v.number(),
  createdAt: v.number(),
  updatedAt: v.number(),
})
  .index("by_order", ["orderId"])
  .index("by_license_number", ["licenseNumber"])
  .index("by_buyer_email", ["buyerEmail"]);
```

---

## ðŸš€ SYSTÃˆME DE PAIEMENT IMPLÃ‰MENTÃ‰

### Architecture Actuelle

Le systÃ¨me utilise **Stripe** et **PayPal** directement pour les paiements, avec les fonctionnalitÃ©s suivantes :

1. **Stripe Checkout** : Paiements par carte bancaire
2. **PayPal SDK** : Paiements PayPal
3. **Webhooks validÃ©s** : Synchronisation automatique
4. **Licences PDF** : GÃ©nÃ©ration automatique de certificats
5. **Historique complet** : Suivi de tous les paiements

### Composants ImplÃ©mentÃ©s

```typescript
// client/src/components/payments/
- StripeCheckout : IntÃ©gration Stripe Checkout
- PayPalButton : IntÃ©gration PayPal SDK
- CompletePaymentFlow : Flux complet
- PaymentWebhookHandler : Gestion webhooks

// client/src/components/licenses/
- LicensePicker : SÃ©lection de licence
- LicensePreviewModal : AperÃ§u avant achat
- license-preview : Composant d'aperÃ§u
```

### Webhooks ImplÃ©mentÃ©s

```typescript
// server/routes/webhooks/
- stripe.ts : Gestion webhooks Stripe
- paypal.ts : Gestion webhooks PayPal

// Ã‰vÃ©nements gÃ©rÃ©s :
- Stripe : payment_intent.succeeded, payment_intent.failed
- PayPal : PAYMENT.SALE.COMPLETED, PAYMENT.SALE.DENIED
- Validation avec idempotence (table processedEvents)
```

### Flux de Paiement

1. **SÃ©lection de licence** : Utilisateur choisit Basic/Premium/Unlimited
2. **Checkout** : Redirection vers Stripe Checkout ou PayPal
3. **Paiement** : Traitement du paiement
4. **Webhook** : Synchronisation automatique avec Convex
5. **Licence PDF** : GÃ©nÃ©ration et envoi automatique
6. **Confirmation** : Page de confirmation avec dÃ©tails

---

## âœ… SYSTÃˆME VALIDÃ‰

### Tests Fonctionnels (ImplÃ©mentÃ©s)

- [x] **Paiements Stripe** : Flux complet avec Stripe Checkout
- [x] **Paiements PayPal** : Flux complet avec PayPal SDK
- [x] **Gestion des licences** : GÃ©nÃ©ration PDF automatique
- [x] **Webhooks** : Synchronisation automatique Stripe/PayPal
- [x] **Interface** : Affichage correct des commandes et licences

### Tests Techniques (ImplÃ©mentÃ©s)

- [x] **SÃ©curitÃ©** : Validation des webhooks Stripe/PayPal
- [x] **Performance** : Temps de rÃ©ponse < 500ms
- [x] **Erreurs** : Gestion des cas d'Ã©chec de paiement
- [x] **Synchronisation** : CohÃ©rence Stripe/PayPal â†” Convex
- [x] **Responsive** : Interface mobile optimisÃ©e

### Tests de Paiement (ImplÃ©mentÃ©s)

- [x] **Cartes de test** : Validation avec cartes Stripe test
- [x] **Ã‰checs de paiement** : Gestion des erreurs
- [x] **Remboursements** : Processus de remboursement
- [x] **Historique** : Suivi complet des paiements
- [x] **Licences PDF** : GÃ©nÃ©ration et tÃ©lÃ©chargement

---

## ðŸ“ˆ MÃ‰TRIQUES DE SUCCÃˆS

### Objectifs Quantitatifs

- **Taux de conversion** : > 15% (visiteurs â†’ abonnÃ©s)
- **Temps de checkout** : < 2 minutes
- **Taux d'Ã©chec paiement** : < 5%
- **Satisfaction utilisateur** : > 4.5/5
- **Temps de rÃ©ponse API** : < 500ms

### Objectifs Qualitatifs

- **ExpÃ©rience utilisateur** : Fluide et intuitive
- **SÃ©curitÃ©** : ConformitÃ© PCI DSS via Clerk
- **FiabilitÃ©** : 99.9% de disponibilitÃ©
- **Support** : RÃ©solution < 24h

---

## ðŸš¨ RISQUES ET MITIGATION

### Risques IdentifiÃ©s

1. **Ã‰checs de synchronisation** Clerk â†” Convex

   - _Mitigation_ : SystÃ¨me de retry et logs dÃ©taillÃ©s

2. **ProblÃ¨mes de webhooks**

   - _Mitigation_ : Validation et monitoring des webhooks

3. **Erreurs de paiement**

   - _Mitigation_ : Gestion d'erreurs robuste et notifications

4. **Quotas incorrects**
   - _Mitigation_ : Tests automatisÃ©s et validation en temps rÃ©el

---

## ðŸ“… PLANNING DÃ‰TAILLÃ‰

### Semaine 1 : Configuration et Base

- **Jour 1-2** : Configuration Clerk Dashboard
- **Jour 3-4** : Mise Ã  jour hooks et composants
- **Jour 5** : Tests unitaires

### Semaine 2 : IntÃ©gration et Webhooks

- **Jour 1-2** : ImplÃ©mentation webhooks
- **Jour 3-4** : Interface de gestion
- **Jour 5** : Tests d'intÃ©gration

### Semaine 3 : Tests et Validation

- **Jour 1-2** : Tests de paiement complets
- **Jour 3-4** : Optimisations et corrections
- **Jour 5** : Validation finale et documentation

---

## ðŸŽ¯ PROCHAINES Ã‰TAPES

### Actions ImmÃ©diates

1. **Configurer Clerk Billing** dans le Dashboard
2. **CrÃ©er les plans d'abonnement** (Basic, Artist, Ultimate)
3. **DÃ©finir les features** et permissions
4. **Mettre Ã  jour les variables d'environnement**

### Actions Prioritaires

1. **ImplÃ©menter les webhooks** Clerk
2. **Mettre Ã  jour useClerkBilling** avec la vraie logique
3. **CrÃ©er l'interface de gestion** des abonnements
4. **Tester le flux complet** de paiement

---

## ðŸ“š RESSOURCES

### Documentation

- [Clerk Billing Documentation](https://clerk.com/docs/billing)
- [Clerk Webhooks Guide](https://clerk.com/docs/webhooks)
- [Convex Schema Documentation](https://docs.convex.dev/database/schemas)

### Outils de Test

- Cartes de test Stripe
- Webhook testing tools
- Postman collections

---

**âœ… SystÃ¨me de paiement opÃ©rationnel !**

_Le systÃ¨me utilise Stripe et PayPal directement pour les paiements. Clerk est utilisÃ© uniquement pour l'authentification. Toutes les fonctionnalitÃ©s de paiement sont implÃ©mentÃ©es et opÃ©rationnelles._

---

_Document mis Ã  jour le 26 janvier 2025 - Version 2.0_
